// Prisma Schema for Jeweller Pricing Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Single user authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// Customer model - Client database
model Customer {
  id        String   @id @default(cuid())
  name      String
  company   String?
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  quotes Quote[]

  @@map("customers")
}

// Category model - Item categories (Rings, Earrings, Necklaces, etc.)
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items Item[]

  @@map("categories")
}

// Item model - Jewellery items/products
model Item {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  description String?
  categoryId  String   @map("category_id")
  basePrice   Decimal? @map("base_price") @db.Decimal(12, 2)
  imageUrl    String?  @map("image_url")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category   Category    @relation(fields: [categoryId], references: [id])
  quoteItems QuoteItem[]

  @@map("items")
}

// Supplier model - Material suppliers
model Supplier {
  id          String   @id @default(cuid())
  name        String
  contactName String?  @map("contact_name")
  email       String?
  phone       String?
  address     String?
  website     String?
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  materials  Material[]
  resources  SupplierResource[]
  components Component[]

  @@map("suppliers")
}

// SupplierResource model - Uploaded price lists and catalogs
model SupplierResource {
  id         String   @id @default(cuid())
  supplierId String   @map("supplier_id")
  name       String
  category   String   // diamonds, gemstones, findings, metals, chains, components
  fileName   String   @map("file_name")
  fileType   String   @map("file_type") // pdf, xlsx, csv, html
  filePath   String   @map("file_path")
  fileSize   Int      @map("file_size")
  notes      String?
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  supplier   Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  components Component[]

  @@map("supplier_resources")
}

// Component model - Parsed items from supplier price lists
model Component {
  id             String   @id @default(cuid())
  resourceId     String?  @map("resource_id")
  supplierId     String?  @map("supplier_id")
  sku            String?
  name           String
  description    String?
  category       String   // diamond, gemstone, finding, metal, chain, component
  subCategory    String?  @map("sub_category") // round, princess, clasp, setting
  unit           String   @default("each") // each, gram, carat, meter
  priceUsd       Decimal? @map("price_usd") @db.Decimal(12, 4)
  priceZar       Decimal? @map("price_zar") @db.Decimal(12, 2)
  size           String?  // e.g., "1.5mm", "2ct"
  quality        String?  // e.g., "VS1", "AAA"
  specifications Json?    // flexible field for extra attributes
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  resource   SupplierResource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)
  supplier   Supplier?         @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  quoteItems QuoteItem[]

  @@map("components")
}

// Material model - Raw materials from suppliers
model Material {
  id           String   @id @default(cuid())
  name         String
  type         String   // e.g., "gemstone", "finding", "chain", "clasp"
  unit         String   // e.g., "piece", "gram", "carat", "meter"
  pricePerUnit Decimal  @map("price_per_unit") @db.Decimal(12, 4)
  currency     String   @default("ZAR")
  supplierId   String?  @map("supplier_id")
  sku          String?
  description  String?
  inStock      Boolean  @default(true) @map("in_stock")
  lastUpdated  DateTime @default(now()) @map("last_updated")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@map("materials")
}

// MetalPrice model - Live precious metal prices
model MetalPrice {
  id        String   @id @default(cuid())
  metalType String   @map("metal_type") // e.g., "gold", "silver", "platinum", "palladium", "rhodium"
  karat     Int?     // For gold: 9, 14, 18, 22, 24
  purity    Decimal? @db.Decimal(5, 2) // Percentage purity
  priceUsd  Decimal  @map("price_usd") @db.Decimal(12, 4) // Price per gram in USD
  priceZar  Decimal  @map("price_zar") @db.Decimal(12, 4) // Price per gram in ZAR
  fetchedAt DateTime @default(now()) @map("fetched_at")

  @@unique([metalType, karat])
  @@map("metal_prices")
}

// ExchangeRate model - Currency conversion rates
model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency String   @map("from_currency")
  toCurrency   String   @map("to_currency")
  rate         Decimal  @db.Decimal(12, 6)
  fetchedAt    DateTime @default(now()) @map("fetched_at")

  @@unique([fromCurrency, toCurrency])
  @@map("exchange_rates")
}

// Quote model - Customer quotes
model Quote {
  id          String      @id @default(cuid())
  quoteNumber String      @unique @map("quote_number")
  customerId  String      @map("customer_id")
  skuCode     String?     @map("sku_code")
  status      QuoteStatus @default(DRAFT)
  subtotal    Decimal     @default(0) @db.Decimal(12, 2)
  markupPct   Decimal     @default(0) @map("markup_pct") @db.Decimal(5, 2)
  markupAmt   Decimal     @default(0) @map("markup_amt") @db.Decimal(12, 2)
  discount    Decimal     @default(0) @db.Decimal(12, 2)
  totalZar    Decimal     @default(0) @map("total_zar") @db.Decimal(12, 2)
  quoteData   Json?       @map("quote_data") // Stores all form data as JSON
  notes       String?
  validUntil  DateTime?   @map("valid_until")
  version     Int         @default(1)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  customer Customer       @relation(fields: [customerId], references: [id])
  items    QuoteItem[]
  versions QuoteVersion[]

  @@map("quotes")
}

// QuoteItem model - Line items in a quote
model QuoteItem {
  id           String   @id @default(cuid())
  quoteId      String   @map("quote_id")
  itemId       String?  @map("item_id")
  componentId  String?  @map("component_id")
  description  String
  quantity     Int      @default(1)
  labourHours  Decimal  @default(0) @map("labour_hours") @db.Decimal(6, 2)
  labourRate   Decimal  @default(0) @map("labour_rate") @db.Decimal(10, 2)
  labourTotal  Decimal  @default(0) @map("labour_total") @db.Decimal(12, 2)
  metalType    String?  @map("metal_type")
  metalKarat   Int?     @map("metal_karat")
  metalGrams   Decimal  @default(0) @map("metal_grams") @db.Decimal(8, 3)
  metalPrice   Decimal  @default(0) @map("metal_price") @db.Decimal(12, 4)
  metalTotal   Decimal  @default(0) @map("metal_total") @db.Decimal(12, 2)
  accessories  Json?    // Array of accessories with name and price
  extrasTotal  Decimal  @default(0) @map("extras_total") @db.Decimal(12, 2)
  unitPrice    Decimal  @default(0) @map("unit_price") @db.Decimal(12, 2)
  lineTotal    Decimal  @default(0) @map("line_total") @db.Decimal(12, 2)
  notes        String?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  quote     Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  item      Item?      @relation(fields: [itemId], references: [id])
  component Component? @relation(fields: [componentId], references: [id])

  @@map("quote_items")
}

// QuoteVersion model - Version history for quotes
model QuoteVersion {
  id           String   @id @default(cuid())
  quoteId      String   @map("quote_id")
  versionNum   Int      @map("version_num")
  snapshotJson Json     @map("snapshot_json") // Full quote snapshot
  changeNotes  String?  @map("change_notes")
  createdAt    DateTime @default(now()) @map("created_at")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, versionNum])
  @@map("quote_versions")
}

// Settings model - Application settings
model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// Quote status enum
enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED // Converted to invoice (future)
}